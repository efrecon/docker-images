#!/bin/bash

im="abiosoft/caddy"
MINVER="0.11"

if [ -z "$(echo "$im" | grep -o '/')" ]; then
    hub="https://registry.hub.docker.com/v2/repositories/library/$im/tags/"
else
    hub="https://registry.hub.docker.com/v2/repositories/$im/tags/"
fi

# Modified from
# http://www.googlinux.com/list-all-tags-of-docker-image/index.html to support
# wget/curl and not rely on jq
echo "============== Figuring out all tags for $im"

# Get number of pages
if [ -z "$(command -v curl)" ]; then
    first=$(wget -q -O - $hub)
else
    first=$(curl -sL $hub)
fi
count=$(echo $first | sed -E 's/\{\s*"count":\s*([0-9]+).*/\1/')
pagination=$(echo $first | grep -Eo '"name":\s*"[a-zA-Z0-9_.-]+"' | wc -l)
pages=$(expr $count / $pagination + 1)

# Get all tags one page after the other
tags=
i=0
while [ $i -le $pages ] ;
do
    i=$(expr $i + 1)
    if [ -z "$(command -v curl)" ]; then
        page=$(curl -sL "$hub?page=$i")
    else
        page=$(wget -q -O - "$hub?page=$i")
    fi
    ptags=$(echo $page | grep -Eo '"name":\s*"[a-zA-Z0-9_.-]+"' | sed -E 's/"name":\s*"([a-zA-Z0-9_.-]+)"/\1/')
    tags="${ptags} $tags"
done

puretags=$(echo $tags | grep -Eo '[0-9]+(.[0-9]+)*')

# From: https://stackoverflow.com/a/37939589
function version { echo "$@" | awk -F. '{ printf("%d%03d%03d%03d\n", $1,$2,$3,$4); }'; }


IMG=$(basename $DOCKER_REPO)
for tag in $puretags; do
    if [ $(version $tag) -ge $(version $MINVER) ]; then
        echo "============== Building ${IMG}:$tag"
        docker push ${DOCKER_REPO}:$tag
    fi
done
